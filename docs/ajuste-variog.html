<!DOCTYPE html>
<html lang="es" xml:lang="es">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.3 Ajuste de un modelo válido | Estadística Espacial con R</title>
  <meta name="description" content="Apuntes de Estadística Espacial (para las asignaturas: ‘Análisis estadístico de datos con dependencia’ del Grado en Ciencia e Ingeniería de Datos y ‘Aprendizaje estadístico’ del Máster InterUniversitario en Técnicas Estadísticas)." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="3.3 Ajuste de un modelo válido | Estadística Espacial con R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Apuntes de Estadística Espacial (para las asignaturas: ‘Análisis estadístico de datos con dependencia’ del Grado en Ciencia e Ingeniería de Datos y ‘Aprendizaje estadístico’ del Máster InterUniversitario en Técnicas Estadísticas)." />
  <meta name="github-repo" content="rubenfcasal/estadistica_espacial" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.3 Ajuste de un modelo válido | Estadística Espacial con R" />
  
  <meta name="twitter:description" content="Apuntes de Estadística Espacial (para las asignaturas: ‘Análisis estadístico de datos con dependencia’ del Grado en Ciencia e Ingeniería de Datos y ‘Aprendizaje estadístico’ del Máster InterUniversitario en Técnicas Estadísticas)." />
  

<meta name="author" content="Rubén Fernández Casal (MODES, CITIC, UDC; ruben.fcasal@udc.es)" />
<meta name="author" content="Tomás Cotos Yáñez (SIDOR, UVIGO; cotos@uvigo.es)" />


<meta name="date" content="2021-12-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="modelos-variog.html"/>
<link rel="next" href="comentarios-sobre-los-distintos-métodos.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.19/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Estadística Espacial con R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Prólogo</a></li>
<li class="chapter" data-level="1" data-path="intro-estesp.html"><a href="intro-estesp.html"><i class="fa fa-check"></i><b>1</b> Introducción: Procesos espaciales y Geoestadística</a>
<ul>
<li class="chapter" data-level="1.1" data-path="proc-esp.html"><a href="proc-esp.html"><i class="fa fa-check"></i><b>1.1</b> Procesos espaciales</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="proc-esp.html"><a href="proc-esp.html#paquetes-r"><i class="fa fa-check"></i><b>1.1.1</b> Paquetes de R</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="geoestadistica.html"><a href="geoestadistica.html"><i class="fa fa-check"></i><b>1.2</b> Geoestadística</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="geoestadistica.html"><a href="geoestadistica.html#modelos-clasicos-espaciales"><i class="fa fa-check"></i><b>1.2.1</b> Modelos clásicos y modelos espaciales</a></li>
<li class="chapter" data-level="1.2.2" data-path="geoestadistica.html"><a href="geoestadistica.html#ventajas-de-la-aproximación-espacial-y-espacio-temporal"><i class="fa fa-check"></i><b>1.2.2</b> Ventajas de la aproximación espacial (y espacio-temporal)</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="procesos-estacionarios.html"><a href="procesos-estacionarios.html"><i class="fa fa-check"></i><b>1.3</b> Procesos espaciales estacionarios</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="procesos-estacionarios.html"><a href="procesos-estacionarios.html#propiedades-elementales"><i class="fa fa-check"></i><b>1.3.1</b> Propiedades elementales del covariograma y del variograma</a></li>
<li class="chapter" data-level="1.3.2" data-path="procesos-estacionarios.html"><a href="procesos-estacionarios.html#procesos-agregados"><i class="fa fa-check"></i><b>1.3.2</b> Procesos agregados</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="objetivos-esquema.html"><a href="objetivos-esquema.html"><i class="fa fa-check"></i><b>1.4</b> Objetivos y pasos</a></li>
<li class="chapter" data-level="1.5" data-path="el-paquete-gstat.html"><a href="el-paquete-gstat.html"><i class="fa fa-check"></i><b>1.5</b> El paquete <strong>gstat</strong></a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="datos.html"><a href="datos.html"><i class="fa fa-check"></i><b>2</b> Datos espaciales</a>
<ul>
<li class="chapter" data-level="2.1" data-path="datos-tipos.html"><a href="datos-tipos.html"><i class="fa fa-check"></i><b>2.1</b> Tipos de datos espaciales</a></li>
<li class="chapter" data-level="2.2" data-path="sf-intro.html"><a href="sf-intro.html"><i class="fa fa-check"></i><b>2.2</b> Introducción al paquete <strong>sf</strong></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="sf-intro.html"><a href="sf-intro.html#crs"><i class="fa fa-check"></i><b>2.2.1</b> Sistemas de referencia de coordenadas</a></li>
<li class="chapter" data-level="2.2.2" data-path="sf-intro.html"><a href="sf-intro.html#tidyverse-sf"><i class="fa fa-check"></i><b>2.2.2</b> Integración con el ecosistema <strong>tidyverse</strong></a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="representación-de-datos-espaciales.html"><a href="representación-de-datos-espaciales.html"><i class="fa fa-check"></i><b>2.3</b> Representación de datos espaciales</a></li>
<li class="chapter" data-level="2.4" data-path="operaciones-datos.html"><a href="operaciones-datos.html"><i class="fa fa-check"></i><b>2.4</b> Operaciones con datos espaciales</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="operaciones-datos.html"><a href="operaciones-datos.html#importación-y-exportación-de-datos-espaciales"><i class="fa fa-check"></i><b>2.4.1</b> Importación y exportación de datos espaciales</a></li>
<li class="chapter" data-level="2.4.2" data-path="operaciones-datos.html"><a href="operaciones-datos.html#operaciones-con-geometrías"><i class="fa fa-check"></i><b>2.4.2</b> Operaciones con geometrías</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="sp-eda.html"><a href="sp-eda.html"><i class="fa fa-check"></i><b>2.5</b> Análisis exploratorio de datos espaciales</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="modelado.html"><a href="modelado.html"><i class="fa fa-check"></i><b>3</b> Modelado de procesos geoestadísticos</a>
<ul>
<li class="chapter" data-level="3.1" data-path="vario-muestrales.html"><a href="vario-muestrales.html"><i class="fa fa-check"></i><b>3.1</b> Estimadores muestrales del semivariograma</a></li>
<li class="chapter" data-level="3.2" data-path="modelos-variog.html"><a href="modelos-variog.html"><i class="fa fa-check"></i><b>3.2</b> Modelos de semivariogramas</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="modelos-variog.html"><a href="modelos-variog.html#modelos-parametricos"><i class="fa fa-check"></i><b>3.2.1</b> Modelos paramétricos isotrópicos</a></li>
<li class="chapter" data-level="3.2.2" data-path="modelos-variog.html"><a href="modelos-variog.html#anisotropia"><i class="fa fa-check"></i><b>3.2.2</b> Modelado de anisotropía</a></li>
<li class="chapter" data-level="3.2.3" data-path="modelos-variog.html"><a href="modelos-variog.html#vario-lin-reg"><i class="fa fa-check"></i><b>3.2.3</b> El modelo lineal de regionalización</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ajuste-variog.html"><a href="ajuste-variog.html"><i class="fa fa-check"></i><b>3.3</b> Ajuste de un modelo válido</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="ajuste-variog.html"><a href="ajuste-variog.html#ls-fit"><i class="fa fa-check"></i><b>3.3.1</b> Estimación por mínimos cuadrados</a></li>
<li class="chapter" data-level="3.3.2" data-path="ajuste-variog.html"><a href="ajuste-variog.html#trend-fit"><i class="fa fa-check"></i><b>3.3.2</b> Modelado del variograma en procesos no estacionarios</a></li>
<li class="chapter" data-level="3.3.3" data-path="ajuste-variog.html"><a href="ajuste-variog.html#ml-fit"><i class="fa fa-check"></i><b>3.3.3</b> Estimación por máxima verosimilitud</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="comentarios-sobre-los-distintos-métodos.html"><a href="comentarios-sobre-los-distintos-métodos.html"><i class="fa fa-check"></i><b>3.4</b> Comentarios sobre los distintos métodos</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="kriging.html"><a href="kriging.html"><i class="fa fa-check"></i><b>4</b> Predicción Kriging</a>
<ul>
<li class="chapter" data-level="4.1" data-path="introduccion.html"><a href="introduccion.html"><i class="fa fa-check"></i><b>4.1</b> Introducción</a></li>
<li class="chapter" data-level="4.2" data-path="ksimple.html"><a href="ksimple.html"><i class="fa fa-check"></i><b>4.2</b> Kriging con media conocida: kriging simple</a></li>
<li class="chapter" data-level="4.3" data-path="kuniversal.html"><a href="kuniversal.html"><i class="fa fa-check"></i><b>4.3</b> Kriging con media desconocida: kriging universal y kriging residual</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="kuniversal.html"><a href="kuniversal.html#ku-covariograma"><i class="fa fa-check"></i><b>4.3.1</b> Ecuaciones en función del covariograma</a></li>
<li class="chapter" data-level="4.3.2" data-path="kuniversal.html"><a href="kuniversal.html#kriging-residual"><i class="fa fa-check"></i><b>4.3.2</b> Kriging residual</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="kriging-con-el-paquete-gstat.html"><a href="kriging-con-el-paquete-gstat.html"><i class="fa fa-check"></i><b>4.4</b> Kriging con el paquete <strong>gstat</strong></a></li>
<li class="chapter" data-level="4.5" data-path="consideraciones-kriging.html"><a href="consideraciones-kriging.html"><i class="fa fa-check"></i><b>4.5</b> Consideraciones acerca de los métodos kriging</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="consideraciones-kriging.html"><a href="consideraciones-kriging.html#kriging-interpolador"><i class="fa fa-check"></i><b>4.5.1</b> Kriging como interpolador</a></li>
<li class="chapter" data-level="4.5.2" data-path="consideraciones-kriging.html"><a href="consideraciones-kriging.html#efecto-variog-kriging"><i class="fa fa-check"></i><b>4.5.2</b> Efecto del variograma (covariograma) en el kriging</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="validacion-cruzada.html"><a href="validacion-cruzada.html"><i class="fa fa-check"></i><b>4.6</b> Validación cruzada del modelo ajustado</a></li>
<li class="chapter" data-level="4.7" data-path="otros-métodos-kriging.html"><a href="otros-métodos-kriging.html"><i class="fa fa-check"></i><b>4.7</b> Otros métodos kriging</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="otros-métodos-kriging.html"><a href="otros-métodos-kriging.html#block-kriging"><i class="fa fa-check"></i><b>4.7.1</b> Block kriging</a></li>
<li class="chapter" data-level="4.7.2" data-path="otros-métodos-kriging.html"><a href="otros-métodos-kriging.html#kriging-trans-normal"><i class="fa fa-check"></i><b>4.7.2</b> Kriging trans-normal</a></li>
<li class="chapter" data-level="4.7.3" data-path="otros-métodos-kriging.html"><a href="otros-métodos-kriging.html#kriging-indicador"><i class="fa fa-check"></i><b>4.7.3</b> Kriging indicador</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="multivar.html"><a href="multivar.html"><i class="fa fa-check"></i><b>5</b> Procesos espaciales multivariantes</a></li>
<li class="chapter" data-level="6" data-path="esp-temp.html"><a href="esp-temp.html"><i class="fa fa-check"></i><b>6</b> Procesos espaciales espacio-temporales</a></li>
<li class="appendix"><span><b>Apendices</b></span></li>
<li class="chapter" data-level="A" data-path="intro-sp.html"><a href="intro-sp.html"><i class="fa fa-check"></i><b>A</b> Introducción al paquete <strong>sp</strong></a>
<ul>
<li class="chapter" data-level="A.1" data-path="tipos-de-objetos.html"><a href="tipos-de-objetos.html"><i class="fa fa-check"></i><b>A.1</b> Tipos de objetos</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="tipos-de-objetos.html"><a href="tipos-de-objetos.html#spatialpoints-y-spatialpointsdataframe"><i class="fa fa-check"></i><b>A.1.1</b> SpatialPoints y SpatialPointsDataFrame</a></li>
<li class="chapter" data-level="A.1.2" data-path="tipos-de-objetos.html"><a href="tipos-de-objetos.html#spatiallines-y-spatialpolygons"><i class="fa fa-check"></i><b>A.1.2</b> SpatialLines y SpatialPolygons</a></li>
<li class="chapter" data-level="A.1.3" data-path="tipos-de-objetos.html"><a href="tipos-de-objetos.html#spatialgrid-y-spatialpixels"><i class="fa fa-check"></i><b>A.1.3</b> SpatialGrid y SpatialPixels</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="métodos-y-procedimientos-clases-sp.html"><a href="métodos-y-procedimientos-clases-sp.html"><i class="fa fa-check"></i><b>A.2</b> Métodos y procedimientos clases sp</a>
<ul>
<li class="chapter" data-level="A.2.1" data-path="métodos-y-procedimientos-clases-sp.html"><a href="métodos-y-procedimientos-clases-sp.html#importarexportartransformar"><i class="fa fa-check"></i><b>A.2.1</b> Importar/exportar/transformar</a></li>
</ul></li>
<li class="chapter" data-level="A.3" data-path="representaciones-gráficas.html"><a href="representaciones-gráficas.html"><i class="fa fa-check"></i><b>A.3</b> Representaciones gráficas</a>
<ul>
<li class="chapter" data-level="A.3.1" data-path="representaciones-gráficas.html"><a href="representaciones-gráficas.html#gráficos-estándar"><i class="fa fa-check"></i><b>A.3.1</b> Gráficos estándar</a></li>
<li class="chapter" data-level="A.3.2" data-path="representaciones-gráficas.html"><a href="representaciones-gráficas.html#gráficos-lattice-spplot"><i class="fa fa-check"></i><b>A.3.2</b> Gráficos lattice: spplot</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="intro-geoR.html"><a href="intro-geoR.html"><i class="fa fa-check"></i><b>B</b> Introducción al paquete <strong>geoR</strong></a>
<ul>
<li class="chapter" data-level="B.1" data-path="inicio-de-una-sesión-y-de-carga-de-datos.html"><a href="inicio-de-una-sesión-y-de-carga-de-datos.html"><i class="fa fa-check"></i><b>B.1</b> Inicio de una sesión y de carga de datos</a>
<ul>
<li class="chapter" data-level="B.1.1" data-path="inicio-de-una-sesión-y-de-carga-de-datos.html"><a href="inicio-de-una-sesión-y-de-carga-de-datos.html#archivos-de-datos"><i class="fa fa-check"></i><b>B.1.1</b> Archivos de datos</a></li>
</ul></li>
<li class="chapter" data-level="B.2" data-path="análisis-descriptivo-de-datos-geoestadísticos.html"><a href="análisis-descriptivo-de-datos-geoestadísticos.html"><i class="fa fa-check"></i><b>B.2</b> Análisis descriptivo de datos geoestadísticos</a></li>
<li class="chapter" data-level="B.3" data-path="modelado-de-la-dependencia.html"><a href="modelado-de-la-dependencia.html"><i class="fa fa-check"></i><b>B.3</b> Modelado de la dependencia</a>
<ul>
<li class="chapter" data-level="B.3.1" data-path="modelado-de-la-dependencia.html"><a href="modelado-de-la-dependencia.html#variogramas-empíricos"><i class="fa fa-check"></i><b>B.3.1</b> Variogramas empíricos</a></li>
<li class="chapter" data-level="B.3.2" data-path="modelado-de-la-dependencia.html"><a href="modelado-de-la-dependencia.html#geor-ajuste"><i class="fa fa-check"></i><b>B.3.2</b> Ajuste de un modelo de variograma</a></li>
<li class="chapter" data-level="B.3.3" data-path="modelado-de-la-dependencia.html"><a href="modelado-de-la-dependencia.html#inferencia-sobre-el-variograma"><i class="fa fa-check"></i><b>B.3.3</b> Inferencia sobre el variograma</a></li>
<li class="chapter" data-level="B.3.4" data-path="modelado-de-la-dependencia.html"><a href="modelado-de-la-dependencia.html#estimación-del-variograma-en-procesos-no-estacionarios"><i class="fa fa-check"></i><b>B.3.4</b> Estimación del variograma en procesos no estacionarios</a></li>
</ul></li>
<li class="chapter" data-level="B.4" data-path="predicción-espacial-kriging.html"><a href="predicción-espacial-kriging.html"><i class="fa fa-check"></i><b>B.4</b> Predicción espacial (kriging)</a>
<ul>
<li class="chapter" data-level="B.4.1" data-path="predicción-espacial-kriging.html"><a href="predicción-espacial-kriging.html#validación-cruzada"><i class="fa fa-check"></i><b>B.4.1</b> Validación cruzada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="referencias.html"><a href="referencias.html"><i class="fa fa-check"></i>Referencias</a>
<ul>
<li class="chapter" data-level="" data-path="bibliografía-completa.html"><a href="bibliografía-completa.html"><i class="fa fa-check"></i>Bibliografía completa</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Estadística Espacial con R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="ajuste-variog" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Ajuste de un modelo válido</h2>
<p>Como ya se comentó anteriormente, en general los estimadores del variograma no pueden ser usados directamente en la predicción espacial;
no son condicionalmente semidefinidos negativos y eso puede causar por ejemplo sistemas kriging inválidos o estimaciones negativas de la varianza kriging.
Este problema normalmente se remedia buscando un modelo paramétrico válido que describa adecuadamente la dependencia espacial presente en los datos.
Supongamos que <span class="math inline">\(P=\left\{ 2\gamma(\mathbf{h};\boldsymbol{\theta}):\boldsymbol{\theta}\in \Theta \right\}\)</span>, donde <span class="math inline">\(2\gamma(\mathbf{h};\boldsymbol{\theta})\)</span> es un variograma válido en <span class="math inline">\(\mathbb{R}^{d}\)</span> (normalmente isotrópico), es la familia parametrizada de variogramas escogida.
Se trata de encontrar el mejor elemento de <span class="math inline">\(P\)</span>, para lo que se han propuesto diversos criterios de bondad de ajuste (ver p.e. Cressie, 1993, Sección 2.6).
Entre ellos hay que destacar los basados en mínimos cuadrados y en máxima verosimilitud, descritos a continuación.</p>
<div id="ls-fit" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Estimación por mínimos cuadrados</h3>
<p>Supongamos que <span class="math inline">\(2\gamma(\mathbf{h};\boldsymbol{\theta}_{0})\)</span> es el variograma teórico y que <span class="math inline">\(\hat{\gamma}_{i} =\hat{\gamma}(\mathbf{h}_{i})\)</span>, <span class="math inline">\(i = 1,\ldots,K\)</span>, son las estimaciones del semivariograma obtenidas utilizando algún tipo de estimador piloto (p.e. alguno de los mostrados en la Sección 4.1.1).
Normalmente, siguiendo las recomendaciones sugeridas por Journel y Huijbregts (1978, p. 194), solamente se consideran en el ajuste saltos menores o iguales que la mitad del máximo salto (i.e. <span class="math inline">\(\left\| \mathbf{h}_{i} \right\| \leq \frac{1}{2} \max \left\{ \left\| \mathbf{s}_{k} -\mathbf{s}_{l} \right\| \right\}\)</span>); y, si se utiliza el estimador empírico (o uno similar), de forma que el número de aportaciones a cada estimación sea por lo menos de treinta (i.e. <span class="math inline">\(\left| N(\mathbf{h}_{i})\right| \geq 30\)</span>).
Habitualmente (e.g. Cressie, 1993, p. 96-97) la estimación por mínimos cuadrados de <span class="math inline">\(\boldsymbol{\theta}_{0}\)</span> se obtiene al minimizar:
<span class="math display" id="eq:ls-obj">\[\begin{equation} 
  \left( \hat{\boldsymbol{\gamma}} - \boldsymbol{\gamma}(\boldsymbol{\theta})\right)^{\top } \mathbf{V}(\boldsymbol{\theta})\left( \hat{\boldsymbol{\gamma}} - \boldsymbol{\gamma}(\boldsymbol{\theta})\right),
  \tag{3.3}
\end{equation}\]</span>
<!-- \@ref(eq:ls-obj) -->
siendo <span class="math inline">\(\hat{\boldsymbol{\gamma}} =(\hat{\gamma}(\mathbf{h}_1),\ldots,\hat{\gamma} (\mathbf{h}_{K}))^\top\)</span>, <span class="math inline">\(\boldsymbol{\gamma}(\boldsymbol{\theta})=(\gamma(\mathbf{h}_1 ;\boldsymbol{\theta}),\ldots,\gamma(\mathbf{h}_{K} ;\boldsymbol{\theta}))^\top\)</span>
y <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta})\)</span> una matriz <span class="math inline">\(K\times K\)</span> semidefinida positiva que puede
depender de <span class="math inline">\(\boldsymbol{\theta}\)</span>, considerando alguno de los siguientes casos:</p>
<ul>
<li><p>Mínimos cuadrados ordinarios (OLS): <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta}) = \mathbf{I}_{K}\)</span>,
la matriz identidad <span class="math inline">\(K\times K\)</span>.</p></li>
<li><p>Mínimos cuadrados ponderados (WLS): <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta}) = \text{diag}(w_1 (\boldsymbol{\theta}),\ldots,w_{K}(\boldsymbol{\theta}))\)</span>,
con <span class="math inline">\(w_{i}(\boldsymbol{\theta})\geq 0\)</span>, <span class="math inline">\(i=1,\ldots,K\)</span>.
Normalmente se suele tomar estos pesos inversamente proporcionales a <span class="math inline">\(Var(\hat{\gamma}(\mathbf{h}_{i}))\)</span>.</p></li>
<li><p>Mínimos cuadrados generalizados (GLS): <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta})=\boldsymbol{\Sigma}_{\hat{\boldsymbol{\gamma}}} (\boldsymbol{\theta})^{-1}\)</span>,
la inversa de la matriz de covarianzas (asintótica) de <span class="math inline">\(\hat{\boldsymbol{\gamma}}\)</span> obtenida suponiendo que el variograma teórico es <span class="math inline">\(2\gamma(\mathbf{h};\boldsymbol{\theta})\)</span>.</p></li>
</ul>
<p>Es importante señalar que al utilizar el criterio GLS el cálculo de la matriz de covarianzas <span class="math inline">\(\boldsymbol{\Sigma}_{\hat{\boldsymbol{\gamma}}} (\boldsymbol{\theta})\)</span> generalmente no resulta fácil (por ejemplo en Cressie 1993, p. 96, se tienen las expresiones para el estimador empírico y el estimador robusto, suponiendo normalidad).
Esto produce que la minimización de la función objetivo <a href="ajuste-variog.html#eq:ls-obj">(3.3)</a> sea computacionalmente prohibitiva en muchos casos.
El método de mínimos cuadrados ponderados puede verse como un compromiso entre la eficiencia del método de GLS y la simplicidad del método de OLS.
Además, suponiendo normalidad y que el variograma teórico es <span class="math inline">\(2\gamma(\mathbf{h};\boldsymbol{\theta})\)</span>, Cressie (1985) probó que:
<span class="math display">\[Var(\hat{\gamma}(\mathbf{h}_{i}))\simeq 2\dfrac{\gamma(\mathbf{h}_{i}
;\boldsymbol{\theta})^2 }{\left| N(\mathbf{h}_{i})\right| },\]</span>
en el caso del estimador empírico; y para el estimador robusto:
<span class="math display">\[Var(\tilde{\gamma}(\mathbf{h}_{i}))\simeq 2.885\dfrac{\gamma
(\mathbf{h}_{i} ;\boldsymbol{\theta})^2 }{\left| N(\mathbf{h}_{i})\right| },\]</span>
siendo esta aproximación incluso mejor que en el caso anterior.
Proponiendo en estos casos la minimización de:
<span class="math display">\[\sum\limits_{i=1}^{K} w_{i}(\boldsymbol{\theta}) \left( \hat{\gamma}(\mathbf{h}_{i}) - \gamma(\mathbf{h}_{i};\boldsymbol{\theta}) \right)^2,\]</span>
siendo <span class="math inline">\(w_{i}(\boldsymbol{\theta}) = \left| N(\mathbf{h}_{i})\right| /\gamma(\mathbf{h}_{i} ;\boldsymbol{\theta})^2\)</span>, como aproximación al criterio WLS.</p>
<p>Estos métodos de ajuste tiene unas propiedades interesantes, cuanto mayor sea <span class="math inline">\(\left| N(\mathbf{h}_{i})\right|\)</span> mayor peso recibe el residuo en el salto <span class="math inline">\(\mathbf{h}_{i}\)</span> y además, cuanto más pequeño sea el valor del variograma teórico mayor peso recibe también el residuo correspondiente.
Por este motivo, los saltos próximos al origen típicamente reciben mayor peso con lo que se consigue un buen ajuste del modelo de variograma cerca del origen (esto es especialmente importante; ver p.e. Stein, 1988, y comentarios en la Sección 4.X).
Adicionalmente estos métodos pueden ser implementados fácilmente en la práctica (de forma similar al OLS).</p>
<p>Aunque para obtener las expresiones (o aproximaciones) de las varianzas y covarianzas de las estimaciones piloto se supone habitualmente que la distribución de los datos es normal, se puede probar fácilmente que los procedimientos de ajuste obtenidos son también válidos para el caso de datos normales transformados (ver p.e. Cressie, 1993, p. 98).
Esta es una de las principales ventajas de los métodos WLS o GLS frente a otras alternativas (como los métodos basados en máxima verosimilitud); como utilizan solamente la estructura de segundo orden (asintótica) del estimador del variograma, no es necesario hacer suposiciones sobre la distribución completa de los datos<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a>.</p>
<p>Como comentario final, en la función objetivo <a href="ajuste-variog.html#eq:ls-obj">(3.3)</a> de los criterios WLS y GLS anteriores, la matriz de pesos utilizada en el ajuste <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta})\)</span> depende también del parámetro sobre el que se realiza la minimización (y al minimizar <a href="ajuste-variog.html#eq:ls-obj">(3.3)</a> en cierto sentido se están maximizando también las varianzas), por lo que puede ser preferible utilizar un algoritmo iterativo.
Por ejemplo comenzar con pesos OLS (o WLS con <span class="math inline">\(w_{i} = \left| N(\mathbf{h}_{i})\right| / \| \mathbf{h}_{i} \|^2\)</span>) y posteriormente en cada etapa <span class="math inline">\(k\)</span> obtener una nueva aproximación <span class="math inline">\(\hat{\boldsymbol{\theta}}_{0}^{(k)}\)</span> al minimizar:
<span class="math display">\[\left( \hat{\boldsymbol{\gamma}} - \boldsymbol{\gamma}(\boldsymbol{\theta})\right)^{\top } \mathbf{V}(\hat{\boldsymbol{\theta}}_{0}^{(k-1)})\left( \hat{\boldsymbol{\gamma}} - \boldsymbol{\gamma}(\boldsymbol{\theta})\right),\]</span>
repitiendo este proceso hasta convergencia (realmente muchos de los algoritmos diseñados para el ajuste por mínimos cuadrados proceden de esta forma).</p>
<p>En <code>gstat</code> el ajuste OLS y WLS se realiza mediante la función:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="ajuste-variog.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fit.variogram</span>(object, model, <span class="at">fit.sills =</span> <span class="cn">TRUE</span>, <span class="at">fit.ranges =</span> <span class="cn">TRUE</span>,</span>
<span id="cb93-2"><a href="ajuste-variog.html#cb93-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">fit.method =</span> <span class="dv">7</span>, <span class="at">fit.kappa =</span> <span class="cn">FALSE</span>, ...)</span></code></pre></div>
<ul>
<li><p><code>object</code>: semivariograma empírico, obtenido con la función <code>variogram()</code>.</p></li>
<li><p><code>model</code>: modelo de semivariograma, generado con la función <code>vgm()</code>.</p></li>
<li><p><code>fit.sills</code>, <code>fit.ranges</code>, <code>fit.kappa</code>: determinan si se ajustan los correspondientes parámetros (<code>TRUE</code>) o se mantienen fijos (<code>FALSE</code>).</p></li>
<li><p><code>fit.method</code>: selección de los pesos en el criterio WLS.</p>
<ul>
<li><code>fit.method = 6</code>: <span class="math inline">\(w_{i} = 1\)</span>, OLS.</li>
<li><code>fit.method = 1</code>: <span class="math inline">\(w_{i} = \left| N(\mathbf{h}_{i})\right|\)</span>.</li>
<li><code>fit.method = 7</code>: <span class="math inline">\(w_{i} = \left| N(\mathbf{h}_{i})\right| / \| \mathbf{h}_{i} \|^2\)</span>.</li>
<li><code>fit.method = 2</code>: <span class="math inline">\(w_{i} = \left| N(\mathbf{h}_{i})\right| /\gamma(\mathbf{h}_{i} ;\boldsymbol{\theta})^2\)</span>.</li>
</ul></li>
</ul>
<p>Los parámetros iniciales se fijan a los establecidos en <code>model</code>. Si alguno es desconocido (<code>NA</code>), le asigna un valor por defecto:</p>
<ul>
<li>el rango se establece a 1/3 de la distancia máxima del variograma empírico,</li>
<li>al umbral parcial se le asigna el promedio de los últimos 5 valores del variograma empírico,</li>
<li>y el efecto nugget (siempre que haya sido establecido explícitamente con <code>nugget = NA</code>) se toma como la media de los tres primeros valores del variograma empírico.</li>
</ul>
<p>Como ejemplo, a continuación se ajusta un modelo exponencial al variograma empírico calculado en la Sección <a href="vario-muestrales.html#vario-muestrales">3.1</a>, mediante OLS y WLS con diferentes pesos:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="ajuste-variog.html#cb94-1" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="st">&quot;Exp&quot;</span>, <span class="at">nugget =</span> <span class="cn">NA</span>) <span class="co"># Valores iniciales por defecto, incluyendo nugget</span></span>
<span id="cb94-2"><a href="ajuste-variog.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># modelo &lt;- vgm(psill = 0.6, model = &quot;Exp&quot;, range = 0.2, nugget = 0.0) # Valores iniciales</span></span>
<span id="cb94-3"><a href="ajuste-variog.html#cb94-3" aria-hidden="true" tabindex="-1"></a>fit.ols <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vario, <span class="at">model =</span> modelo, <span class="at">fit.method =</span> <span class="dv">6</span>)</span>
<span id="cb94-4"><a href="ajuste-variog.html#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co"># fit.npairs &lt;- fit.variogram(vario, model = modelo, fit.method = 1) # Warning: No convergence</span></span>
<span id="cb94-5"><a href="ajuste-variog.html#cb94-5" aria-hidden="true" tabindex="-1"></a>fit.npairs <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vario, <span class="at">model =</span> fit.ols, <span class="at">fit.method =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## Warning in fit.variogram(vario, model = fit.ols, fit.method = 1): No convergence
## after 200 iterations: try different initial values?</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="ajuste-variog.html#cb96-1" aria-hidden="true" tabindex="-1"></a>fit.lin <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vario, <span class="at">model =</span> modelo, <span class="at">fit.method =</span> <span class="dv">7</span>)</span>
<span id="cb96-2"><a href="ajuste-variog.html#cb96-2" aria-hidden="true" tabindex="-1"></a>fit.cressie <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vario, <span class="at">model =</span> fit.lin, <span class="at">fit.method =</span> <span class="dv">2</span>) </span>
<span id="cb96-3"><a href="ajuste-variog.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Representar:</span></span>
<span id="cb96-4"><a href="ajuste-variog.html#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuidado con plot.variogramModel() si se pretende añadir elementos</span></span>
<span id="cb96-5"><a href="ajuste-variog.html#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vario<span class="sc">$</span>dist, vario<span class="sc">$</span>gamma, <span class="at">xlab =</span> <span class="st">&quot;distance&quot;</span>, <span class="at">ylab =</span>  <span class="st">&quot;semivariance&quot;</span>, </span>
<span id="cb96-6"><a href="ajuste-variog.html#cb96-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb96-7"><a href="ajuste-variog.html#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(fit.ols, <span class="at">maxdist =</span> <span class="fl">0.6</span>), <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb96-8"><a href="ajuste-variog.html#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(fit.npairs, <span class="at">maxdist =</span> <span class="fl">0.6</span>), <span class="at">lty =</span> <span class="dv">3</span>)</span>
<span id="cb96-9"><a href="ajuste-variog.html#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(fit.lin, <span class="at">maxdist =</span> <span class="fl">0.6</span>), <span class="at">lty =</span> <span class="dv">4</span>)</span>
<span id="cb96-10"><a href="ajuste-variog.html#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(fit.cressie, <span class="at">maxdist =</span> <span class="fl">0.6</span>))</span>
<span id="cb96-11"><a href="ajuste-variog.html#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomright&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;ols&quot;</span>, <span class="st">&quot;npairs&quot;</span>, <span class="st">&quot;default (linear)&quot;</span>, <span class="st">&quot;cressie&quot;</span>), <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">1</span>))</span></code></pre></div>
<p><img src="03-modelado_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="ajuste-variog.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parámetros estimados:</span></span>
<span id="cb97-2"><a href="ajuste-variog.html#cb97-2" aria-hidden="true" tabindex="-1"></a>fit.cressie</span></code></pre></div>
<pre><code>##   model   psill     range
## 1   Nug 0.13495 0.0000000
## 2   Exp 1.15982 0.6403818</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="ajuste-variog.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error ajuste</span></span>
<span id="cb99-2"><a href="ajuste-variog.html#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(fit.cressie, <span class="st">&quot;SSErr&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 52.83535</code></pre>
<p>En <code>gstat</code> el ajuste GLS se podría realizar mediante la función:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="ajuste-variog.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fit.variogram.gls</span>(formula, data, model, <span class="at">maxiter =</span> <span class="dv">30</span>, <span class="at">eps =</span> .<span class="dv">01</span>, </span>
<span id="cb101-2"><a href="ajuste-variog.html#cb101-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">trace =</span> <span class="cn">TRUE</span>, <span class="at">ignoreInitial =</span> <span class="cn">TRUE</span>, <span class="at">cutoff =</span> <span class="cn">Inf</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Sin embargo, actualmente solo admite datos tipo <code>Spatial*</code> del paquete <code>sp</code> y además es habitual que aparezcan problemas computacionales, por lo que no se recomendaría su uso.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="ajuste-variog.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fit.variogram.gls</span>(z <span class="sc">~</span> <span class="dv">1</span>, <span class="fu">as</span>(datos, <span class="st">&quot;Spatial&quot;</span>), modelo, </span>
<span id="cb102-2"><a href="ajuste-variog.html#cb102-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">maxiter =</span> <span class="dv">2</span>, <span class="at">cutoff =</span> <span class="fl">0.6</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb102-3"><a href="ajuste-variog.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Error in if (any(model$range &lt; 0)) { :  missing value where TRUE/FALSE needed</span></span></code></pre></div>
</div>
<div id="trend-fit" class="section level3" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Modelado del variograma en procesos no estacionarios</h3>
<p>Como ya se comentó en la introducción de este capítulo, si no se puede asumir que la tendencia es constante no es apropiado utilizar directamente los estimadores del semivariograma mostrados en la Sección <a href="vario-muestrales.html#vario-muestrales">3.1</a>.
Por ejemplo, considerando el modelo lineal <a href="geoestadistica.html#eq:modelolineal">(1.2)</a> de la Sección <a href="geoestadistica.html#modelos-clasicos-espaciales">1.2.1</a> (el modelo del <em>kriging universal</em>, Sección 4.X; que emplearemos en el resto de este capítulo), tendríamos que:
<span class="math display">\[E(Z(\mathbf{s}_1)-Z(\mathbf{s}_{2}))^2 =2\gamma(\mathbf{s}_1
-\mathbf{s}_{2}) + \left( \sum\limits_{j=0}^{p}\beta_{j}  \left( X_{j}
(\mathbf{s}_1)-X_{j}(\mathbf{s}_{2})\right) \right)^2.\]</span>
Muchas veces, cuando las estimaciones experimentales del semivariograma aparentan no estar acotadas (e.g. Figura <a href="ajuste-variog.html#fig:aquifer-var-trend">3.5</a> izquierda), es debido a que la tendencia no está especificada correctamente.</p>
<p>El procedimiento habitual en geoestadística es eliminar la tendencia y estimar el variograma a partir de los residuos. Por ejemplo, en este caso, podríamos considerar los residuos de un ajuste OLS de la tendencia:
<span class="math display">\[\mathbf{r}_{ols} =\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}}_{ols} =\left( \mathbf{I}_{n}
- (\mathbf{X}^{\top}\mathbf{X})^{-1}\mathbf{X}^{\top} \right)\mathbf{Z}.\]</span>
Esto se puede hacer con la función <code>variogram()</code> del paquete <code>gstat</code> especificando la fórmula del modelo como primer argumento (ver Figura <a href="ajuste-variog.html#fig:aquifer-var-trend">3.5</a> derecha).</p>
<p>Como ejemplo consideraremos los datos del acuífero Wolfcamp:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="ajuste-variog.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;datos/aquifer.RData&quot;</span>)</span>
<span id="cb103-2"><a href="ajuste-variog.html#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb103-3"><a href="ajuste-variog.html#cb103-3" aria-hidden="true" tabindex="-1"></a>aquifer<span class="sc">$</span>head <span class="ot">&lt;-</span> aquifer<span class="sc">$</span>head<span class="sc">/</span><span class="dv">100</span> <span class="co"># en cientos de pies</span></span>
<span id="cb103-4"><a href="ajuste-variog.html#cb103-4" aria-hidden="true" tabindex="-1"></a>aquifer_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(aquifer, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="at">remove =</span> <span class="cn">FALSE</span>, <span class="at">agr =</span> <span class="st">&quot;constant&quot;</span>)</span>
<span id="cb103-5"><a href="ajuste-variog.html#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co"># maxlag &lt;- 0.5*sqrt(sum(diff(matrix(st_bbox(aquifer_sf), nrow = 2, byrow = TRUE))^2))</span></span>
<span id="cb103-6"><a href="ajuste-variog.html#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="ajuste-variog.html#cb103-7" aria-hidden="true" tabindex="-1"></a>vario.est <span class="ot">&lt;-</span> <span class="fu">variogram</span>(head <span class="sc">~</span> <span class="dv">1</span>, aquifer_sf, <span class="at">cutoff =</span> <span class="dv">150</span>)</span>
<span id="cb103-8"><a href="ajuste-variog.html#cb103-8" aria-hidden="true" tabindex="-1"></a>vario.resid <span class="ot">&lt;-</span> <span class="fu">variogram</span>(head <span class="sc">~</span> lon <span class="sc">+</span> lat, aquifer_sf, <span class="at">cutoff =</span> <span class="dv">150</span>)    </span>
<span id="cb103-9"><a href="ajuste-variog.html#cb103-9" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb103-10"><a href="ajuste-variog.html#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(vario.est) # no compatible con mfrow</span></span>
<span id="cb103-11"><a href="ajuste-variog.html#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(vario.est,  <span class="fu">plot</span>(dist, gamma, <span class="at">xlab =</span> <span class="st">&quot;distance&quot;</span>, <span class="at">ylab =</span>  <span class="st">&quot;semivariance&quot;</span>))</span>
<span id="cb103-12"><a href="ajuste-variog.html#cb103-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(vario.resid)</span></span>
<span id="cb103-13"><a href="ajuste-variog.html#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(vario.resid,  <span class="fu">plot</span>(dist, gamma, <span class="at">xlab =</span> <span class="st">&quot;distance&quot;</span>, <span class="at">ylab =</span>  <span class="st">&quot;semivariance&quot;</span>))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:aquifer-var-trend"></span>
<img src="03-modelado_files/figure-html/aquifer-var-trend-1.png" alt="Semivariograma empírico obtenido asumiendo media constante (izquierda) y a partir de los residuos de un ajuste lineal de la tendencia (derecha), empleando los datos del acuífero Wolfcamp." width="90%" />
<p class="caption">
Figura 3.5: Semivariograma empírico obtenido asumiendo media constante (izquierda) y a partir de los residuos de un ajuste lineal de la tendencia (derecha), empleando los datos del acuífero Wolfcamp.
</p>
</div>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="ajuste-variog.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span></code></pre></div>
<p>El ajuste por WLS se puede realizar también con la función <code>fit.variogram()</code>:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="ajuste-variog.html#cb105-1" aria-hidden="true" tabindex="-1"></a>modelo <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="st">&quot;Sph&quot;</span>, <span class="at">nugget =</span> <span class="cn">NA</span>) <span class="co"># Valores iniciales por defecto</span></span>
<span id="cb105-2"><a href="ajuste-variog.html#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># modelo &lt;- vgm(psill = 3, model = &quot;Sph&quot;, range = 75, nugget = 0) </span></span>
<span id="cb105-3"><a href="ajuste-variog.html#cb105-3" aria-hidden="true" tabindex="-1"></a>fit.resid <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vario.resid, modelo, <span class="at">fit.method =</span> <span class="dv">2</span>)</span>
<span id="cb105-4"><a href="ajuste-variog.html#cb105-4" aria-hidden="true" tabindex="-1"></a>fit.resid</span></code></pre></div>
<pre><code>##   model    psill    range
## 1   Nug 1.095133  0.00000
## 2   Sph 3.044034 63.39438</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="ajuste-variog.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuidado con plot.variogramModel() si se pretende añadir elementos</span></span>
<span id="cb107-2"><a href="ajuste-variog.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(fit.resid, cutoff = 150, ylim = c(0, 4.5))</span></span>
<span id="cb107-3"><a href="ajuste-variog.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># with(vario.resid,  points(dist, gamma))</span></span>
<span id="cb107-4"><a href="ajuste-variog.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(vario.resid, <span class="fu">plot</span>(dist, gamma, <span class="at">xlab =</span> <span class="st">&quot;distance&quot;</span>, <span class="at">ylab =</span>  <span class="st">&quot;semivariance&quot;</span>, </span>
<span id="cb107-5"><a href="ajuste-variog.html#cb107-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">150</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>)))</span>
<span id="cb107-6"><a href="ajuste-variog.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">variogramLine</span>(fit.resid, <span class="at">maxdist =</span> <span class="dv">150</span>))</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:aquifer-var-fit"></span>
<img src="03-modelado_files/figure-html/aquifer-var-fit-1.png" alt="Ajuste de un modelo esférico de semivariograma a las estimaciones empíricas obtenidas a partir de los residuos de un ajuste lineal de la tendencia, empleando los datos del acuífero Wolfcamp." width="70%" />
<p class="caption">
Figura 3.6: Ajuste de un modelo esférico de semivariograma a las estimaciones empíricas obtenidas a partir de los residuos de un ajuste lineal de la tendencia, empleando los datos del acuífero Wolfcamp.
</p>
</div>
<p>Sin embargo, para poder estimar la tendencia de forma eficiente sería necesario conocer la dependencia (i.e. conocer <span class="math inline">\(\gamma(\cdot)\)</span>), que dependería a su vez de la estimación de la tendencia.
Para solventar este problema circular, Neuman y Jacobson (1984) propusieron una aproximación iterativa, empezar con el estimador OLS de <span class="math inline">\(\boldsymbol{\theta}\)</span>, estimar el variograma a partir de los residuos, ajustar un modelo de variograma válido, calcular el estimador GLS basado en el modelo ajustado y así sucesivamente hasta convergencia.
En la práctica este procedimiento suele converger en pocas iteraciones (normalmente menos de 5).
Sin embargo, en el paquete <code>gstat</code> solo se realiza una iteración (se reestimará la tendencia empleando GLS al calcular las predicciones kriging).</p>
<p>En el caso de variogramas no acotados, el proceso <span class="math inline">\(\varepsilon(\cdot)\)</span> no sería estacionario de segundo orden, no está disponible la matriz <span class="math inline">\(\boldsymbol{\Sigma}\)</span> y en principio sería imposible emplear GLS para estimar la tendencia.
Sin embargo, normalmente se suele trabajar en un dominio acotado <span class="math inline">\(D\)</span> y podemos encontrar una constante positiva <span class="math inline">\(A\)</span> tal que <span class="math inline">\(C^{\ast }(\mathbf{h})= A-\gamma(\mathbf{h})\geq 0,\forall \mathbf{h}\in D\)</span> (y por tanto esta función es un covariograma válido en ese dominio).
La función <span class="math inline">\(C^{\ast }(\mathbf{h})\)</span> se suele denominar <em>pseudo-covariograma</em> (o covarianza localmente equivalente; ver p.e. Chilès y Delfiner, 1999, Sección 4.6.2).
Si utilizamos <span class="math inline">\(C^{\ast }(\mathbf{h})\)</span> en lugar del covariograma en la estimación de la media (o en las ecuaciones del predictor del KU), la constante <em>A</em> se cancela y obtenemos los mismos resultados (sin embargo las varianzas si que dependen de esta constante).</p>
<!-- 
En R, por ejemplo, podríamos volver a reestimar la tendencia mediante GLS y calcular los nuevos residuos mediante la función `gls()` del paquete `nlme`, que realmente emplea estimación por máxima verosimilitud.

```r
gls(model, data, correlation, weights, method, control, ...)
```
-->
<p>Adicionalmente, habría que tener en cuenta también que la variabilidad de los residuos no es la de los errores teóricos (algo que normalmente se ignora).
Para ilustrar este problema supongamos que el proceso de error <span class="math inline">\(\varepsilon(\cdot)\)</span> es estacionario de segundo orden con covariograma conocido <span class="math inline">\(C(\cdot)\)</span> de forma que podemos calcular el estimador lineal óptimo de <span class="math inline">\(\boldsymbol{\beta}\)</span>:
<span class="math display">\[\hat{\boldsymbol{\beta}}_{gls} =(\mathbf{X}^{\top}\boldsymbol{\Sigma}^{-1} \mathbf{X})^{-1} \mathbf{X}^{\top}\boldsymbol{\Sigma}^{-1} \mathbf{Z} = \mathbf{P}_{gls}\mathbf{Z},\]</span>
siendo <span class="math inline">\(\mathbf{P}_{gls}\)</span> la matriz de proyección.
Empleando este estimador obtenemos el vector de residuos:
<span class="math display">\[\mathbf{r} =\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}}_{ols} =\left( \mathbf{I}_{n} - \mathbf{P}_{gls} \right)\mathbf{Z},\]</span>
cuya matriz de varianzas-covarianzas resulta ser:
<span class="math display">\[\begin{aligned}
Var(\mathbf{r}) &amp;=(\mathbf{I}_{n} -\mathbf{P}_{gls})\boldsymbol{\Sigma}(\mathbf{I}_{n}
-\mathbf{P}_{gls})^\top  \\
&amp; = \boldsymbol{\Sigma} - \mathbf{X}(\mathbf{X}^\top\boldsymbol{\Sigma}^{-1} \mathbf{X})^{-1}
\mathbf{X}^\top.
\end{aligned}\]</span>
De donde se deduce que si utilizamos directamente los residuos, incluso procediendo de la forma más eficiente, se introduce un sesgo en la estimación de la dependencia espacial.
Explícitamente, si denotamos por <span class="math inline">\(\hat{\mu}(\mathbf{s})\)</span> la estimación GLS de la tendencia, puede verse que:
<span class="math display">\[\begin{aligned}
C_{\mathbf{r}}(\mathbf{s}_{i} ,\mathbf{s}_{j}) &amp;= Cov\left(Z(\mathbf{s}_{i})-\hat{\mu}(\mathbf{s}_{i}), Z(\mathbf{s}_{j} ) - \hat{\mu}(\mathbf{s}_{j})\right) \\
&amp;= C(\mathbf{s}_{i} -\mathbf{s}_{j}) - Cov(\hat{\mu}(\mathbf{s}_{i} ), \hat{\mu}(\mathbf{s}_{j})),
\end{aligned}\]</span>
y expresado en función del semivariograma:
<span class="math display">\[\gamma_{\mathbf{r}}(\mathbf{s}_{i} ,\mathbf{s}_{j}) = \gamma
(\mathbf{s}_{i} -\mathbf{s}_{j})-\frac{1}{2} Var(\hat{\mu}
(\mathbf{s}_{i})-\hat{\mu}(\mathbf{s}_{j})).\]</span></p>
<p>Por tanto al utilizar alguno de los estimadores mostrados anteriormente con los residuos estimados obtenemos estimaciones sesgadas del semivariograma teórico.
Matheron (1971, pp. 152-155) ya notó que, por lo general, el sesgo del estimador del semivariograma es pequeño en los saltos próximos al origen, pero más sustancial en saltos grandes<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>.
Parece ser que este problema provocó una desilusión con el kriging universal y la iniciativa hacia el kriging con funciones intrínsecamente estacionarias (ver p.e. Matheron, 1973; Cressie, 1993, Sección 5.4; o Chilès y Delfiner, 1999, cap. 4).</p>
<p>En cuanto a las consecuencias de que el estimador del variograma no sea insesgado en el kriging universal, hay que tener en cuenta que:</p>
<ul>
<li>Al ajustar un modelo de variograma por mínimos cuadrados ponderados o generalizados (Sección <a href="ajuste-variog.html#ls-fit">3.3.1</a>), automáticamente los saltos pequeños reciben mayor peso en el ajuste.</li>
<li>Además si la predicción espacial se lleva a cabo con un criterio de vecindad, el variograma sólo es evaluado en saltos pequeños, donde se tiene una buena estimación y un buen ajuste.</li>
<li>También hay que tener en cuenta el resultado de Stein (1988), i.e. para una predicción eficiente generalmente sólo es necesario capturar la conducta del variograma cerca del origen</li>
</ul>
<p>Por lo anterior, el desencanto con el kriging universal ha sido prematuro, el efecto del sesgo del estimador del variograma sobre el predictor del kriging universal es pequeño.
Sin embargo la varianza del kriging universal se ve más afectada y es menor de lo que debería ser (para más detalles ver Cressie, 1993, pp. 296-299).
Adicionalmente se han propuesto alternativas a los métodos de ajuste basados en mínimos cuadrados que tienen en cuenta el sesgo en la estimación del variograma (e.g. Beckers y Bogaert, 1998; Fernandez-Casal y Francisco-Fernandez, 2014, función <a href="https://rubenfcasal.github.io/npsp/reference/np.svar.html"><code>npsp::np.svariso.corr()</code></a>).</p>
<p>Otra alternativa sería asumir normalidad y estimar ambos componentes de forma conjunta empleando alguno de los métodos basados en máxima verosimilitud descritos en la siguiente sección (que también tienen problemas de sesgo).</p>
</div>
<div id="ml-fit" class="section level3" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Estimación por máxima verosimilitud</h3>
<p>La estimación por máxima verosimilitud (<em>maximum likelihood</em>, ML) es un método muy conocido en inferencia estadística paramétrica, aunque su uso en geoestadística ha sido relativamente reciente (a partir de mediados de los 80).
Además la estimación ML tiene una conexión directa con la estimación Bayesiana (e.g. Handcock y Wallis, 1994) y el empleo de estas herramientas en estadística espacial ha experimentado un notable aumento en los últimos años (e.g. <a href="https://spacetimewithr.org/">Wikle et al., 2019</a>; <a href="https://www.paulamoraga.com/book-geospatial/">Moraga, 2020</a>).</p>
<p>Si suponemos que la distribución de los datos es normal:
<span class="math display">\[\mathbf{Z}\sim \mathcal{N}(\mathbf{X}\boldsymbol{\beta},\boldsymbol{\Sigma}),\]</span>
donde <span class="math inline">\(\boldsymbol{\Sigma}=\boldsymbol{\Sigma}(\boldsymbol{\theta})\)</span> (utilizando la notación de secciones anteriores), se puede deducir fácilmente la expresión de la función de verosimilitud y obtener las estimaciones de los parámetros buscando los valores que la maximizan.</p>
<p>En este caso, la función de densidad de los datos es:
<span class="math display">\[f(\mathbf{z})=(2\pi )^{-\frac{n}{2} } \left| \boldsymbol{\Sigma} \right|^{-\frac{1}{2} }
\exp \left\{ -\dfrac{1}{2}(\mathbf{z}-\mathbf{X}\boldsymbol{\beta})^\top \boldsymbol{\Sigma}^{-1}(\mathbf{z}-\mathbf{X}\boldsymbol{\beta})\right\}.\]</span>
Además en la mayoría de los casos podemos reparametrizar el covariograma<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a> de forma que:
<span class="math display">\[\boldsymbol{\Sigma}=\sigma^2 \mathbf{V}(\boldsymbol{\theta}),\]</span>
siendo <span class="math inline">\(\sigma^2\)</span> la varianza desconocida (o umbral total), y se obtiene que la expresión del logaritmo negativo de la función de verosimilitud (<em>negative log likelihood</em>, NLL) es:
<span class="math display">\[\begin{aligned}
\mathcal{L}(\boldsymbol{\theta},\boldsymbol{\beta},\sigma^2 \left| \mathbf{Z} \right.) &amp; = \dfrac{n}{2} \ln (2\pi) + \dfrac{n}{2} \ln(\sigma^2) + \dfrac{1}{2} \ln \left| \mathbf{V}(\boldsymbol{\theta}) \right|  \\
&amp; + \ \dfrac{1}{2\sigma^2 }(\mathbf{Z}-\mathbf{X}\boldsymbol{\beta})^\top \mathbf{V}(\boldsymbol{\theta})^{-1}(\mathbf{Z}-\mathbf{X}\boldsymbol{\beta}),
\end{aligned}\]</span>
donde <span class="math inline">\(\left| \mathbf{V}(\boldsymbol{\theta})\right|\)</span> denota el determinante de la matriz <span class="math inline">\(\mathbf{V}(\boldsymbol{\theta})\)</span>.
Las estimaciones de los parámetros <span class="math inline">\((\boldsymbol{\theta}, \boldsymbol{\beta}, \sigma^2)\)</span> se obtendrán minimizando el NLL.
Un resultado bien conocido es que el mínimo se obtiene, independientemente de <span class="math inline">\(\boldsymbol{\theta}\)</span>, para:
<span class="math display" id="eq:estimadores-ml">\[\begin{equation} 
  \begin{aligned}
  \hat{\boldsymbol{\beta}} &amp; =(\mathbf{X}^\top\mathbf{V}(\boldsymbol{\theta})^{-1} \mathbf{X})^{-1} \mathbf{X}^\top\mathbf{V}(\boldsymbol{\theta})^{-1} \mathbf{Z}, \\
  \hat{\sigma }^2 &amp; =\dfrac{1}{n}(\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}})^\top
  \mathbf{V}(\boldsymbol{\theta})^{-1}(\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}}).
  \end{aligned}
  \tag{3.4}
\end{equation}\]</span> <!-- \@ref(eq:estimadores-ml) -->
Por tanto la función a minimizar respecto a <span class="math inline">\(\boldsymbol{\theta}\)</span> es:
<span class="math display">\[\mathcal{L}(\boldsymbol{\theta}\left| \mathbf{Z}\right. )=\mathcal{L}(\hat{\boldsymbol{\beta}} ,\boldsymbol{\theta},\hat{\sigma }^2 \left|
\mathbf{Z}\right. ) = \dfrac{n}{2} \ln (2\pi ) + \dfrac{n}{2} \ln (\hat{\sigma
}^2) + \dfrac{1}{2} \ln \left| \mathbf{V}(\boldsymbol{\theta})\right| +\dfrac{n}{2}.\]</span>
Para ello es necesario utilizar algoritmos de minimización no lineal multidimensional.
Además está el problema de la posible multimodalidad de esta función (ver p.e. Mardia y Watkins, 1989), por tanto habría que asegurarse de que el algoritmo elegido no converge a un mínimo local.
Si <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span> es la estimación de <span class="math inline">\(\boldsymbol{\theta}\)</span> obtenida al resolver este problema, sustituyendo en <a href="ajuste-variog.html#eq:estimadores-ml">(3.4)</a> se obtienen las estimaciones del resto de parámetros<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>.</p>
<p>Uno de los principales problemas de la estimación ML es que los estimadores de <span class="math inline">\(\sigma^2\)</span> y <span class="math inline">\(\boldsymbol{\theta}\)</span> pueden tener un sesgo considerable (especialmente cuando la tendencia no es constante), algo que es bastante conocido en la estimación de la varianza con datos independientes.
Este problema se puede resolver (por lo menos en parte) utilizando una variante de este método.</p>
<p>El método de máxima verosimilitud restringida (<em>restricted maximum likelihood</em>, REML) se basa en la idea de filtrar los datos de forma que la distribución conjunta no dependa de <span class="math inline">\(\boldsymbol{\beta}\)</span>.
Se trata de maximizar la verosimilitud de <span class="math inline">\(m=n-p-1\)</span> contrastes de error linealmente independientes:
<span class="math display">\[\mathbf{Y}=\boldsymbol{\Lambda}\mathbf{Z},\]</span>
siendo <span class="math inline">\(\boldsymbol{\Lambda}\)</span> una matriz <span class="math inline">\(m\times n\)</span> de rango <span class="math inline">\(m\)</span> y tal que <span class="math inline">\(\boldsymbol{\Lambda}\mathbf{X}=\mathbf{0}\)</span> (i.e. <span class="math inline">\(E(\mathbf{Y}) = \mathbf{0}\)</span>).
Estas combinaciones lineales también se denominan habitualmente <em>incrementos generalizados</em> y, asumiendo normalidad, su distribución no depende de <span class="math inline">\(\boldsymbol{\beta}\)</span>:
<span class="math display">\[\mathbf{Y}\sim \mathcal{N}(\mathbf{0},\boldsymbol{\Lambda}\boldsymbol{\Sigma}\boldsymbol{\Lambda}^\top).\]</span>
De forma análoga al caso anterior podríamos obtener la correspondiente función de verosimilitud. Además, Harville (1974) demostró que las verosimilitudes de distintos incrementos generalizados son iguales salvo una constante y que se pueden obtener expresiones simplificadas
seleccionando la matriz <span class="math inline">\(\boldsymbol{\Lambda}\)</span> de forma que <span class="math inline">\(\boldsymbol{\Lambda}^\top \boldsymbol{\Lambda}=\mathbf{I}_{n} -\mathbf{X}(\mathbf{X^\top}\mathbf{X})^{-1} \mathbf{X}^\top\)</span> y <span class="math inline">\(\boldsymbol{\Lambda}\boldsymbol{\Lambda}^\top =\mathbf{I}_{m}\)</span>, obteniéndose la siguiente expresión para el NLL:</p>
<p><span class="math display">\[\begin{aligned}
\mathcal{L}(\boldsymbol{\theta}\left| \mathbf{Y}\right. ) 
&amp; = \dfrac{m}{2} \ln (2\pi ) + \dfrac{m}{2} \ln (\hat{\sigma}_{Y}^2) -\dfrac{1}{2} \left| \mathbf{X}^\top\mathbf{X}\right|  \\
&amp; + \ \dfrac{1}{2} \left| \mathbf{X}^\top\mathbf{V}(\boldsymbol{\theta})^{-1}
\mathbf{X}\right| +\dfrac{1}{2} \ln \left| \mathbf{V}(\boldsymbol{\theta})\right|
+\dfrac{m}{2} ,\end{aligned}\]</span>
siendo:
<span class="math display">\[\hat{\sigma }_{Y}^2 =\dfrac{1}{m}(\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}}
)^\top \mathbf{V}(\boldsymbol{\theta})^{-1}(\mathbf{Z}-\mathbf{X}\hat{\boldsymbol{\beta}}).\]</span></p>
<p>En general se da por hecho que la estimación REML mejora, a veces significativamente, los resultados obtenidos con la estimación ML (sobre todo si <span class="math inline">\(p\)</span> es grande comparado con <span class="math inline">\(n\)</span>).
En numerosos estudios de simulación (e.g. Zimmerman y Zimmerman, 1991; Fernández-Casal et al., 2003b) se ha observado que el sesgo en las estimaciones de los parámetros del variograma es en general menor.
<!-- 
aunque no se han estudiado todavía las propiedades asintóticas teóricas de estos estimadores?
--></p>
<p>En <code>gstat</code> el ajuste mediante REML se podría realizar empleando la función:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="ajuste-variog.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fit.variogram.reml</span>(formula, locations, data, model, <span class="at">degree =</span> <span class="dv">0</span>, ...)</span></code></pre></div>
<p>Sin embargo, aparentemente <strong><em>el método no está bien implementado</em></strong> (emplea <code>formula</code> para un ajuste OLS y después, en el código C interno, considera una tendencia polinómica en las coordenadas determinada por <code>degree</code>), actualmente solo admite datos tipo <code>Spatial*</code> del paquete <code>sp</code> y además es habitual que aparezcan problemas computacionales, por lo que no se recomendaría su uso.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="ajuste-variog.html#cb109-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">psill =</span> <span class="dv">3</span>, <span class="at">model =</span> <span class="st">&quot;Sph&quot;</span>, <span class="at">range =</span> <span class="dv">75</span>, <span class="at">nugget =</span> <span class="dv">0</span>)</span>
<span id="cb109-2"><a href="ajuste-variog.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fit.variogram.reml</span>(head <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> <span class="fu">as</span>(aquifer_sf, <span class="st">&quot;Spatial&quot;</span>), <span class="at">model =</span> model, <span class="at">degree =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##   model      psill range
## 1   Nug -0.7976219     0
## 2   Sph 12.5397527    75</code></pre>
<p>Como aparece en la ayuda de esta función, es preferible usar el paquete <code>geoR</code> (ver Sección <a href="modelado-de-la-dependencia.html#geor-ajuste">B.3.2</a> del apéndice; también se podría emplear el paquete <code>nlme</code>), empleando la función <code>geoR::likfit()</code> para el ajuste y posteriormente <code>as.vgm.variomodel()</code> para convertir el modelo ajustado a un objeto de <code>gstat</code>.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="ajuste-variog.html#cb111-1" aria-hidden="true" tabindex="-1"></a>geor.models <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Exp =</span> <span class="st">&quot;exponential&quot;</span>, <span class="at">Sph =</span> <span class="st">&quot;spherical&quot;</span>, <span class="at">Cir =</span> <span class="st">&quot;circular&quot;</span>, </span>
<span id="cb111-2"><a href="ajuste-variog.html#cb111-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">Gau =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="at">Mat =</span> <span class="st">&quot;matern&quot;</span>, <span class="at">Pow =</span> <span class="st">&quot;power&quot;</span>, <span class="at">Nug =</span> <span class="st">&quot;nugget&quot;</span>, </span>
<span id="cb111-3"><a href="ajuste-variog.html#cb111-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">Lin =</span> <span class="st">&quot;linear&quot;</span>)</span>
<span id="cb111-4"><a href="ajuste-variog.html#cb111-4" aria-hidden="true" tabindex="-1"></a>pars.ini <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">psill =</span> <span class="dv">3</span>, <span class="at">range =</span> <span class="dv">75</span>, <span class="at">nugget =</span> <span class="dv">0</span>, <span class="at">kappa =</span> <span class="fl">0.5</span>)</span>
<span id="cb111-5"><a href="ajuste-variog.html#cb111-5" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> geoR<span class="sc">::</span><span class="fu">likfit</span>(<span class="at">coords =</span> <span class="fu">st_coordinates</span>(aquifer_sf), <span class="at">data =</span> aquifer_sf<span class="sc">$</span>head,</span>
<span id="cb111-6"><a href="ajuste-variog.html#cb111-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">lik.method =</span> <span class="st">&quot;REML&quot;</span>, <span class="at">trend =</span> <span class="st">&quot;1st&quot;</span>, <span class="at">cov.model =</span> geor.models[<span class="st">&quot;Sph&quot;</span>], </span>
<span id="cb111-7"><a href="ajuste-variog.html#cb111-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">ini.cov.pars =</span> pars.ini[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">nugget =</span> pars.ini[<span class="dv">3</span>], <span class="at">kappa =</span> pars.ini[<span class="dv">4</span>])</span></code></pre></div>
<pre><code>## kappa not used for the spherical correlation function
## ---------------------------------------------------------------
## likfit: likelihood maximisation using the function optim.
## likfit: Use control() to pass additional
##          arguments for the maximisation function.
##         For further details see documentation for optim.
## likfit: It is highly advisable to run this function several
##         times with different initial values for the parameters.
## likfit: WARNING: This step can be time demanding!
## ---------------------------------------------------------------
## likfit: end of numerical maximisation.</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="ajuste-variog.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res)</span></code></pre></div>
<pre><code>## Summary of the parameter estimation
## -----------------------------------
## Estimation method: restricted maximum likelihood 
## 
## Parameters of the mean component (trend):
##   beta0   beta1   beta2 
## 26.7704 -0.0701 -0.0634 
## 
## Parameters of the spatial component:
##    correlation function: spherical
##       (estimated) variance parameter sigmasq (partial sill) =  4.545
##       (estimated) cor. fct. parameter phi (range parameter)  =  79.16
##    anisotropy parameters:
##       (fixed) anisotropy angle = 0  ( 0 degrees )
##       (fixed) anisotropy ratio = 1
## 
## Parameter of the error component:
##       (estimated) nugget =  1.191
## 
## Transformation parameter:
##       (fixed) Box-Cox parameter = 1 (no transformation)
## 
## Practical Range with cor=0.05 for asymptotic range: 79.16084
## 
## Maximised Likelihood:
##    log.L n.params      AIC      BIC 
## &quot;-160.4&quot;      &quot;6&quot;  &quot;332.7&quot;  &quot;347.4&quot; 
## 
## non spatial model:
##    log.L n.params      AIC      BIC 
## &quot;-174.5&quot;      &quot;4&quot;  &quot;357.1&quot;  &quot;366.8&quot; 
## 
## Call:
## geoR::likfit(coords = st_coordinates(aquifer_sf), data = aquifer_sf$head, 
##     trend = &quot;1st&quot;, ini.cov.pars = pars.ini[1:2], nugget = pars.ini[3], 
##     kappa = pars.ini[4], cov.model = geor.models[&quot;Sph&quot;], lik.method = &quot;REML&quot;)</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="ajuste-variog.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.vgm.variomodel</span>(res)</span></code></pre></div>
<pre><code>##   model    psill    range
## 1   Nug 1.191129  0.00000
## 2   Sph 4.544502 79.16084</code></pre>
<!-- 
Pendiente:
Estimación con geoR (y nlme?) y conversión del modelo resultante a vgm de gstat
En teoría en el paquete nlme está eficientemente implementado (también se podría emplear el paquete mgcv...)
-->
</div>
</div>
<div class="footnotes">
<hr />
<ol start="14">
<li id="fn14"><p>La distribución y eficiencia asintótica de los estimadores mínimo cuadráticos ha sido estudiada por Lahiri et al. (2003), demostrando su consistencia y normalidad asintótica bajo condiciones muy generales.<a href="ajuste-variog.html#fnref14" class="footnote-back">↩︎</a></p></li>
<li id="fn15"><p>Para un caso particular, Cressie (1993, pp. 166-167) observó que los residuos basados en el estimador GLS dan lugar a un estimador del variograma con sesgo negativo y cuadrático en h.<a href="ajuste-variog.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p>Por ejemplo en el caso de los semivariogramas mostrados en la Sección <a href="modelos-variog.html#modelos-parametricos">3.2.1</a>, si <span class="math inline">\(c_{0}\)</span> es el efecto nugget y <span class="math inline">\(c_1\)</span> el umbral parcial, en lugar de éstos parámetros se considerarían la varianza (umbral) <span class="math inline">\(\sigma^2 =c_{0} +c_1\)</span> y la proporción de nugget en el umbral total <span class="math inline">\(c_{0}^{\ast} =c_{0} /(c_{0} +c_1)\)</span> (lo que equivale a suponer en las expresiones del covariograma que <span class="math inline">\(c_1 =1\)</span> y <span class="math inline">\(0 \leq c_{0} \leq 1\)</span>).<a href="ajuste-variog.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p>El comportamiento asintótico (bajo dominio creciente) de estos estimadores ha sido estudiado por Mardia y Marshal (1984), dando condiciones (no muy fáciles de chequear en la práctica) para su consistencia y normalidad asintótica (ver también Cressie, 1993, Sección 7.3.1).<a href="ajuste-variog.html#fnref17" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="modelos-variog.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="comentarios-sobre-los-distintos-métodos.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rubenfcasal/estadistica_espacial/edit/master/03-modelado.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["estadistica_espacial.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
